flowchart LR
  subgraph Client[signed client]
    D[(Local data)] --> ENC[Encrypt update\nX25519 + AES-GCM]
    ENC --> U["client_update.enc.json + meta"]
  end

  U --> ST[[0G Storage]]
  ST -- CID --> SUBMIT

  subgraph ProviderTEE[Provider (TEE / TEE-sim)]
    SUBMIT[Submit update\n+ attestation JSON]
  end

  AREG[(AccessRegistry)] -. gating .-> EPM
  SUBMIT --> EPM

  subgraph Chain[0G Galileo (EVM)]
    EPM[(EpochManager)]
  end

  EPM --> SCORE[Score updates\ncompute scoresRoot]
  SCORE --> EPM
  EPM --> AGG[Aggregate (FedAvg)]
  AGG --> GM[Global model JSON]
  GM --> H[SHA-256]
  H --> EPM

  GM --> UPLOAD[Upload model to storage]
  UPLOAD -- globalModelCid --> EPM

  EPM -- publishModel(cid, hash, epoch) --> CHAIN[(On-chain anchors)]
  click CHAIN "https://evmrpc-testnet.0g.ai" "0G RPC"
